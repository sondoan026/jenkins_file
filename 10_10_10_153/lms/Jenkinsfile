pipeline {
    agent { label '153_giao_viec' }

    parameters {
        choice(name: 'ACTION', choices: ['restart', 'start', 'stop'], description: 'H√†nh ƒë·ªông')
    } // ƒë√≥ng parameters

    environment  {
        GIT_REPO = "https://github.com/thonguyenduc2010/odoo18.git"
        DB_NAME = "tai_lieu_y_khoa"
        APP_URL = "https://tailieu.scigroup.com.vn"
        TITLE = "T√†i li·ªáu y khoa"
    } // ƒë√≥ng environment

    stages {
        stage('Check action') {
            steps {
                script {
                    env.ACTION = params.ACTION?.trim() ?: 'restart'
                    echo " ACTION selected: ${env.ACTION}"
                }
            }
        } // ƒë√≥ng stage Check action

        stage('Checkout code') {
            steps {
                git branch: env.Branch_Name,
                credentialsId: env.Git_Credentials_Id,
                url: "${GIT_REPO}"
            }
        } // ƒë√≥ng stage checkout code

        stage('Get Commit Info & Send to Telegram') {
            steps {
                script {
                    // L·∫•y th√¥ng tin t·ª´ Git
                    def commitHash = env.GIT_COMMIT ?: sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
                    def commitMessage = sh(script: "git log -1 --pretty=%B", returnStdout: true).trim()
                    def author = sh(script: "git log -1 --pretty=format:'%an'", returnStdout: true).trim()
                    def branch = env.GIT_BRANCH ?: sh(script: "git rev-parse --abbrev-ref HEAD", returnStdout: true).trim()
                    def repoUrl = env.GIT_URL ?: "Unknown Repo"

                    // L·∫•y danh s√°ch v√† s·ªë l∆∞·ª£ng file thay ƒë·ªïi
                    def changedFiles = sh(script: "git diff-tree --no-commit-id --name-only -r ${commitHash}", returnStdout: true).trim()
                    def changedFilesCount = sh(script: "git diff-tree --no-commit-id --name-only -r ${commitHash} | wc -l", returnStdout: true).trim()

                    // Format danh s√°ch file thay ƒë·ªïi
                    def fileList = changedFiles ? changedFiles.split("\n").collect { "üîπ " + it }.join("\n") : "Kh√¥ng c√≥ file thay ƒë·ªïi."

                    // T·∫°o n·ªôi dung tin nh·∫Øn Telegram
                    def message = """
                        üöÄ *Commit m·ªõi tr√™n: ${APP_URL}*
                        üßë‚Äçüíª *Author:* ${author}
                        üìù *Message:* ${commitMessage}
                        """.stripIndent()

                }
            }
        }


        stage('Deploy'){
            steps {
                script {
                if (env.ACTION == "start") {
                    echo "First deployment"
                    sh """
                        mv docker-compose.yml.example docker-compose.yml
                        mv etc/odoo.conf.example etc/odoo.conf
                        mv etc/server.log.example etc/server.log

                        sudo mkdir -p data pg_data
                        sudo chown -R $USER entrypoint.sh data pg_data etc
                        sudo chmod -R 777 entrypoint.sh
                        sudo chmod -R 777 data pg_data etc

                        docker-compose up -d
                    """
                } else if ( env.ACTION == 'restart') {
                    echo "‚ôªÔ∏è Restarting application"
                    sh "docker-compose restart"
                } else {
                    echo "‚õî Stopping application..."
                    sh "docker-compose stop"
                }
            }
            }
        } // ƒë√≥ng stage deploy

    } // ƒë√≥ng stages
}
