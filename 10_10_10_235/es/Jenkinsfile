pipeline {
    agent { label 'master' }

    parameters {
        choice(name: 'ACTION', choices: ['restart', 'start', 'stop'], description: 'HÃ nh Ä‘á»™ng')
    } // Ä‘Ã³ng parameters

    environment {
        TITLE = "Elasticsearch"
    } // Ä‘Ã³ng environment

    stages {

        stage('Check action') {
            steps {
                script {
                    env.ACTION = params.ACTION?.trim() ?: 'restart'
                    echo " ACTION selected:${env.ACTION}"
                }
            }
        } // Ä‘Ã³ng stage Check action

        stage('Checkout code') {
            steps {
                git(
                    branch: env.Branch_Name,
                    credentialsId: env.Git_Credentials_Id,
                    url: env.Git_Repo
                )
            }
        } // Ä‘Ã³ng stage Checkout code

        stage('Get Commit Info & Send to Telegram') {
            steps {
                script {
                    // Láº¥y thÃ´ng tin tá»« Git
                    def commitHash = env.GIT_COMMIT ?: sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
                    def commitMessage = sh(script: "git log -1 --pretty=%B", returnStdout: true).trim()
                    def author = sh(script: "git log -1 --pretty=format:'%an'", returnStdout: true).trim()
                    def branch = env.GIT_BRANCH ?: sh(script: "git rev-parse --abbrev-ref HEAD", returnStdout: true).trim()
                    def repoUrl = env.GIT_URL ?: "Unknown Repo"

                    // Láº¥y danh sÃ¡ch vÃ  sá»‘ lÆ°á»£ng file thay Ä‘á»•i
                    def changedFiles = sh(script: "git diff-tree --no-commit-id --name-only -r ${commitHash}", returnStdout: true).trim()
                    def changedFilesCount = sh(script: "git diff-tree --no-commit-id --name-only -r ${commitHash} | wc -l", returnStdout: true).trim()

                    // Format danh sÃ¡ch file thay Ä‘á»•i
                    def fileList = changedFiles ? changedFiles.split("\n").collect { "ğŸ”¹ " + it }.join("\n") : "KhÃ´ng cÃ³ file thay Ä‘á»•i."

                    // Táº¡o ná»™i dung tin nháº¯n Telegram
                    def message = """
                        ğŸš€ *Commit má»›i trÃªn: ${TITLE}*
                        ğŸ§‘â€ğŸ’» *Author:* ${author}
                        ğŸ“ *Message:* ${commitMessage}
                        """.stripIndent()

                    sendTelegramMessage(message)
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    if (env.ACTION == 'start') {
                        echo "ğŸš€ First deployment"
                        sh """
                        mv docker-compose.yml.example docker-compose.yml

                        sudo chown -R $USER elasticsearch kibana logstash
                        sudo chmod -R 777 elasticsearch/ kibana/ logstash/

                        docker-compose up -d
                        """
                    } else if ( env.ACTION == 'restart') {
                        echo "â™»ï¸ Restarting application"
                        sh "docker-compose restart"
                    } else {
                        echo "â›” Stopping application..."
                        sh "docker-compose stop"
                    }
                }
            }
        } // Ä‘Ã³ng stage Deploy

    } // Ä‘Ã³ng stages

    post {
            success {
                script {
                    sendTelegramMessage("âœ… Pipeline job ${TITLE} Ä‘Ã£ cháº¡y thÃ nh cÃ´ng!")
                }
            }
            failure {
                script {
                    sendTelegramMessage("âŒ Pipeline job ${TITLE} Ä‘Ã£ gáº·p lá»—i! Kiá»ƒm tra log.")
                }
            }
        } // Ä‘Ã³ng post

} // Ä‘Ã³ng pipeline

def sendTelegramMessage(String message) {
    sh """
    curl -s -X POST "https://api.telegram.org/bot6102275063:${env.TELEGRAM_BOT_TOKEN}/sendMessage" \
    -d chat_id=${env.TELEGRAM_CHAT_ID} \
    -d text="${message}"
    """
} // Ä‘Ã³ng hÃ m sendTelegramMessage
