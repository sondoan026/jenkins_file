pipeline {
    agent { label '156_kangnam' }

    parameters {
        choice(name: 'ACTION', choices: ['start', 'restart', 'stop'], description: 'HÃ nh Ä‘á»™ng')
    } // Ä‘Ã³ng parameters

    environment {
        GIT_REPO = "https://github.com/thonguyenduc2010/odoo18.git"
        DB_NAME = "app_loyalty_kn"
    } // Ä‘Ã³ng environment

    stages {

        stage('Check action') {
            steps {
                script {
                    env.ACTION = params.ACTION?.trim() ?: 'restart'
                    echo " ACTION selected:${env.ACTION}"
                    echo " params selected:${params.ACTION}"
                }
            }
        } // Ä‘Ã³ng stage Check action

        stage('Checkout code') {
            steps {
                git(
                    branch: env.Branch_Name,
                    credentialsId: env.Git_Credentials_Id,
                    url: "${GIT_REPO}"
                )
            }
        } // Ä‘Ã³ng stage Checkout code

        stage('Deploy') {
            steps {
                script {
                    if (env.ACTION == 'start') {
                        echo "ğŸš€ First deployment"
                        sh """ 
                        mv docker-compose.yml.example docker-compose.yml
                        mv etc/odoo.conf.example etc/odoo.conf

                        sudo mkdir -p data pg_data
                        sudo chown -R $USER entrypoint.sh data pg_data etc
                        sudo chmod -R 777 entrypoint.sh
                        sudo chmod -R 777 data pg_data etc

                        docker-compose up -d
                        """
                        sendTelegramMessage("ğŸš€ App Loyalty Kangnam Ä‘Ã£ Ä‘Æ°á»£c triá»ƒn khai thÃ nh cÃ´ng!")
                    } else if ( env.ACTION == 'restart') {
                        echo "â™»ï¸ Restarting application"
                        sh "docker-compose restart"
                        sendTelegramMessage("â™»ï¸ App Loyalty Kangnam Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t vÃ  restart!")
                    } else if (env.ACTION == 'stop') {
                        echo "â›” Stopping application..."
                        sh "docker-compose down"
                        sendTelegramMessage("â›” App Loyalty Kangnam Ä‘Ã£ bá»‹ dá»«ng!")
                    } else {
                        echo "âš ï¸ Lá»—i: HÃ nh Ä‘á»™ng khÃ´ng há»£p lá»‡!"
                    }
                }
            }
        } // Ä‘Ã³ng stage Deploy

        post {
            success {
                script {
                    sendTelegramMessage("âœ… Pipeline job Loyalty Kangnam Ä‘Ã£ cháº¡y thÃ nh cÃ´ng!")
                }
            } // Ä‘Ã³ng success
            failure {
                script {
                    sendTelegramMessage("âŒ Pipeline job Loyalty Kangnam Ä‘Ã£ gáº·p lá»—i! Kiá»ƒm tra log.")
                }
            } // Ä‘Ã³ng failure

        } // Ä‘Ã³ng post

    } // Ä‘Ã³ng stages

} // Ä‘Ã³ng pipeline

def sendTelegramMessage(String message) {
    sh """
    curl -s -X POST "https://api.telegram.org/bot6102275063:${env.TELEGRAM_BOT_TOKEN}/sendMessage" \
    -d chat_id=${env.TELEGRAM_CHAT_ID} \
    -d text="${message}"
    """
} // Ä‘Ã³ng hÃ m sendTelegramMessage
